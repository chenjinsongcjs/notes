# TCP粘包和拆包

描述

-   TCP是面向连接的，面向流的，提供高可靠性服务。收发两端（客户端和服务器端）都要有一一成对的 socket，因此，发送端为了将多个发给接收端的包，更有效的发给对方，使用了优化方法（Nagle 算法），将多次间隔较小且数据量小的数据，合并成一个大的数据块，然后进行封包。这样做虽然提高了效率，但是接收端就难于分辨出完整的数据包了，因为面向流的通信是无消息保护边界的
-   由于 TCP 无消息保护边界, 需要在接收端处理消息边界问题，也就是我们所说的粘包、拆包问题。

图示

![](https://notes-pic-cjs.oss-cn-chengdu.aliyuncs.com/obsidian/image_7JuCqd2NOS.png)

假设客户端分别从少委包D1和D2给服务端，由于服务端一次读取到字节数是不确定的，存在以下四种情况：

1\.  服务端分两次读取到了两个独立的数据包，分别是 D1 和 D2，没有粘包和拆包

2\. 服务端一次接受到了两个数据包，D1和D2粘合在一起，称之为TCP粘包

3\. 服务端分两次读取到了数据包，第一次读取到了完整的 D1 包和 D2 包的部分内容，第二次读取到了 D2 包的剩余内容，这称之为TCP拆包

4.服务端分两次读取到了数据包，第一次读取到了 D1 包的部分内容 D1\_1，第二次读取到了 D1 包的剩余部分内容 D1\_2和完整的D2包。

## TCP粘包和拆包的解决方案

-   使用自定义协议+自定义编解码器来解决
-   关键就是解决服务器每次读取数据的长度问题，这个问题解决，就不会出现多读或者少读的情况，从而避免TCP粘包和拆包问题

### 解决方案的案例

[解决方案的案例](https://www.wolai.com/hVBpxdirrScZfbLLaDzExo "解决方案的案例")
